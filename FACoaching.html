<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FA Coaching</title>

    <!-- Global Theme -->
    <?!= include('Theme'); ?>
    <?!= include('ThemeState'); ?>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FA COACHING â€” PAGE STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        body {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            overflow-y: auto;
            min-height: 100vh;
        }

        .fa-container {
            width: 100%;
            max-width: 900px;
            padding: 48px 24px;
            animation: fadeIn 0.5s ease;
        }

        /* Header */
        .fa-header {
            text-align: center;
            margin-bottom: 48px;
            position: relative;
        }

        .fa-header .theme-toggle {
            position: absolute;
            top: 0;
            right: 0;
        }

        .fa-back-link {
            display: inline-block;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: var(--font-sm);
            margin-bottom: var(--spacing-lg);
            transition: color var(--transition-fast);
        }

        .fa-back-link:hover {
            color: var(--text-primary);
            text-decoration: none;
        }

        .fa-logo {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }

        .fa-title {
            font-size: var(--font-xl);
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .fa-subtitle {
            font-size: var(--font-sm);
            color: var(--text-muted);
        }

        /* â”€â”€â”€ Date Picker â”€â”€â”€ */
        .date-picker-section {
            margin-bottom: var(--spacing-xl);
        }

        .date-picker-wrapper {
            position: relative;
            max-width: 320px;
            margin: 0 auto;
        }

        .date-input {
            width: 100%;
            padding: 12px 16px;
            font-family: var(--font-ui);
            font-size: var(--font-base);
            color: var(--text-primary);
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            transition: all var(--transition-fast);
            text-align: center;
            letter-spacing: 0.5px;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .date-input::placeholder {
            color: var(--text-muted);
        }

        .date-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            z-index: 100;
            display: none;
        }

        .date-dropdown.open {
            display: block;
            animation: slideUp 0.2s ease;
        }

        .date-option {
            padding: 10px 16px;
            font-size: var(--font-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: var(--font-mono);
        }

        .date-option:hover {
            background-color: var(--bg-elevated);
            color: var(--text-primary);
        }

        .date-option.selected {
            color: var(--text-primary);
            background-color: var(--bg-elevated);
        }

        /* â”€â”€â”€ Case List â”€â”€â”€ */
        .case-list-section {
            animation: slideUp 0.4s ease;
        }

        .case-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }

        .case-list-title {
            font-size: var(--font-md);
            font-weight: 500;
            color: var(--text-primary);
        }

        .case-count {
            font-size: var(--font-xs);
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        .case-table {
            width: 100%;
            border-collapse: collapse;
        }

        .case-table th {
            text-align: left;
            padding: 10px 16px;
            font-size: var(--font-xs);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        .case-table td {
            padding: 14px 16px;
            font-size: var(--font-sm);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            transition: all var(--transition-fast);
        }

        .case-table tr.case-row {
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .case-table tr.case-row:hover {
            background-color: var(--bg-elevated);
        }

        .case-table tr.case-row:hover td {
            color: var(--text-primary);
        }

        .case-table td.itn-cell {
            font-family: var(--font-mono);
            color: var(--text-primary);
            font-weight: 500;
        }

        .case-table td.notes-cell {
            max-width: 400px;
            line-height: 1.4;
        }

        /* â”€â”€â”€ Case Detail â”€â”€â”€ */
        .case-detail-section {
            animation: slideUp 0.4s ease;
        }

        .detail-back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: var(--font-sm);
            cursor: pointer;
            background: none;
            border: none;
            font-family: var(--font-ui);
            padding: 0;
            margin-bottom: var(--spacing-xl);
            transition: color var(--transition-fast);
        }

        .detail-back-btn:hover {
            color: var(--text-primary);
        }

        .detail-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .detail-row {
            display: flex;
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-lg);
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-field {
            flex: 1;
        }

        .detail-label {
            font-size: var(--font-xs);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
        }

        .detail-value {
            font-size: var(--font-base);
            color: var(--text-primary);
        }

        .detail-value.mono {
            font-family: var(--font-mono);
        }

        .detail-notes-block {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border);
        }

        .detail-notes-text {
            font-size: var(--font-sm);
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* SME Notes */
        .sme-section {
            margin-top: var(--spacing-lg);
        }

        .sme-label {
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .sme-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px 16px;
            font-family: var(--font-ui);
            font-size: var(--font-sm);
            color: var(--text-primary);
            background-color: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            resize: vertical;
            transition: border-color var(--transition-fast);
            line-height: 1.5;
        }

        .sme-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .sme-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .sme-save-btn {
            padding: 10px 24px;
            font-family: var(--font-ui);
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--bg-primary);
            background-color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .sme-save-btn:hover {
            opacity: 0.9;
        }

        .sme-save-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .sme-save-btn.saving {
            pointer-events: none;
            opacity: 0.6;
        }

        /* Toast */
        .fa-toast {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            padding: var(--spacing-md) var(--spacing-lg);
            background-color: var(--bg-card);
            border: 1px solid var(--state-success);
            border-radius: var(--border-radius-lg);
            color: var(--state-success);
            font-size: var(--font-sm);
            z-index: 2000;
            animation: slideUp 0.3s ease;
            display: none;
        }

        .fa-toast.error {
            border-color: var(--state-error);
            color: var(--state-error);
        }

        .fa-toast.show {
            display: block;
        }

        /* Loading */
        .fa-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-xl);
            color: var(--text-muted);
            font-size: var(--font-sm);
        }

        .fa-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Empty State */
        .fa-empty {
            text-align: center;
            padding: var(--spacing-3xl);
            color: var(--text-muted);
        }

        .fa-empty-icon {
            font-size: 36px;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .fa-empty-text {
            font-size: var(--font-sm);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .detail-row {
                flex-direction: column;
                gap: var(--spacing-md);
            }

            .case-table td.notes-cell {
                max-width: 200px;
            }
        }
    </style>
</head>

<body>
    <div class="fa-container">
        <!-- Header -->
        <header class="fa-header">
            <button class="theme-toggle" onclick="Theme.toggle()" title="Toggle theme"
                aria-label="Toggle dark/light mode">
                <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5" />
                    <path
                        d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                </svg>
                <svg class="icon-moon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                </svg>
            </button>
            <a class="fa-back-link" href="<?= ScriptApp.getService().getUrl() ?>">â† Back to Home</a>
            <div class="fa-logo">ğŸ”</div>
            <h1 class="fa-title">FA Coaching</h1>
            <p class="fa-subtitle">Fraud Analysis Case Review & SME Coaching</p>
        </header>

        <!-- Date Picker -->
        <div class="date-picker-section" id="datePickerSection">
            <div class="date-picker-wrapper">
                <input type="text" class="date-input" id="dateInput" placeholder="Select coaching date..."
                    autocomplete="off" spellcheck="false">
                <div class="date-dropdown" id="dateDropdown"></div>
            </div>
        </div>

        <!-- Case List -->
        <div class="case-list-section hidden" id="caseListSection">
            <div class="case-list-header">
                <span class="case-list-title" id="caseListTitle">Cases</span>
                <span class="case-count" id="caseCount"></span>
            </div>
            <div id="caseListContent"></div>
        </div>

        <!-- Case Detail -->
        <div class="case-detail-section hidden" id="caseDetailSection">
            <button class="detail-back-btn" onclick="FACoaching.backToList()">â† Back to list</button>

            <div class="detail-card" id="caseDetailCard"></div>

            <div class="sme-section">
                <div class="sme-label">SME Coaching Notes</div>
                <textarea class="sme-textarea" id="smeNotesInput"
                    placeholder="Enter coaching feedback, observations, or guidance..."></textarea>
                <div class="sme-actions">
                    <button class="sme-save-btn" id="smeSaveBtn" onclick="FACoaching.saveNotes()">Save Notes</button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div class="fa-toast" id="faToast"></div>
    </div>

    <script>
        /**
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         * FA COACHING â€” CLIENT-SIDE LOGIC
         * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         */

        const FACoaching = {
            dates: [],
            cases: [],
            selectedCase: null,
            selectedDate: '',

            // â”€â”€â”€ Init â”€â”€â”€
            init() {
                this.loadDates();
                this.bindEvents();
            },

            // â”€â”€â”€ Load coaching dates â”€â”€â”€
            loadDates() {
                const input = document.getElementById('dateInput');
                input.disabled = true;
                input.placeholder = 'Loading dates...';

                google.script.run
                    .withSuccessHandler(dates => {
                        this.dates = dates || [];
                        input.disabled = false;
                        input.placeholder = 'Type or select a coaching date...';
                    })
                    .withFailureHandler(err => {
                        console.error('Failed to load dates:', err);
                        input.disabled = false;
                        input.placeholder = 'Type a coaching date (MM/DD/YY)...';
                    })
                    .faGetCoachingDates();
            },

            // â”€â”€â”€ Bind events â”€â”€â”€
            bindEvents() {
                const input = document.getElementById('dateInput');
                const dropdown = document.getElementById('dateDropdown');

                input.addEventListener('focus', () => this.showDropdown());
                input.addEventListener('input', () => this.filterDropdown());
                input.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const val = input.value.trim();
                        if (val) this.selectDate(val);
                    }
                    if (e.key === 'Escape') {
                        dropdown.classList.remove('open');
                    }
                });

                // Close dropdown on outside click
                document.addEventListener('click', e => {
                    if (!e.target.closest('.date-picker-wrapper')) {
                        dropdown.classList.remove('open');
                    }
                });
            },

            // â”€â”€â”€ Dropdown logic â”€â”€â”€
            showDropdown() {
                this.renderDropdown(this.dates);
            },

            filterDropdown() {
                const query = document.getElementById('dateInput').value.trim().toLowerCase();
                const filtered = this.dates.filter(d => d.toLowerCase().includes(query));
                this.renderDropdown(filtered);
            },

            renderDropdown(items) {
                const dropdown = document.getElementById('dateDropdown');
                if (!items.length) {
                    dropdown.classList.remove('open');
                    return;
                }

                dropdown.innerHTML = items.map(d =>
                    `<div class="date-option${d === this.selectedDate ? ' selected' : ''}" 
                          onclick="FACoaching.selectDate('${d}')">${d}</div>`
                ).join('');
                dropdown.classList.add('open');
            },

            // â”€â”€â”€ Select date â†’ load cases â”€â”€â”€
            selectDate(dateStr) {
                this.selectedDate = dateStr;
                document.getElementById('dateInput').value = dateStr;
                document.getElementById('dateDropdown').classList.remove('open');

                // Show loading
                const listSection = document.getElementById('caseListSection');
                const detailSection = document.getElementById('caseDetailSection');
                listSection.classList.remove('hidden');
                detailSection.classList.add('hidden');

                document.getElementById('caseListTitle').textContent = `Cases for ${dateStr}`;
                document.getElementById('caseListContent').innerHTML =
                    '<div class="fa-loading"><div class="fa-spinner"></div> Loading cases...</div>';
                document.getElementById('caseCount').textContent = '';

                google.script.run
                    .withSuccessHandler(cases => this.renderCaseList(cases))
                    .withFailureHandler(err => {
                        document.getElementById('caseListContent').innerHTML =
                            '<div class="fa-empty"><div class="fa-empty-icon">âš ï¸</div><div class="fa-empty-text">Failed to load cases</div></div>';
                        console.error(err);
                    })
                    .faGetCasesByDate(dateStr);
            },

            // â”€â”€â”€ Render case list â”€â”€â”€
            renderCaseList(cases) {
                this.cases = cases || [];
                const container = document.getElementById('caseListContent');
                const countEl = document.getElementById('caseCount');

                if (!this.cases.length) {
                    container.innerHTML =
                        '<div class="fa-empty"><div class="fa-empty-icon">ğŸ“‹</div><div class="fa-empty-text">No cases found for this date</div></div>';
                    countEl.textContent = '0 cases';
                    return;
                }

                countEl.textContent = `${this.cases.length} case${this.cases.length !== 1 ? 's' : ''}`;

                let html = `<table class="case-table">
                    <thead>
                        <tr>
                            <th>Analyst</th>
                            <th>ITN</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>`;

                this.cases.forEach((c, i) => {
                    const truncNotes = c.notes.length > 80 ? c.notes.substring(0, 80) + 'â€¦' : c.notes;
                    html += `<tr class="case-row" onclick="FACoaching.selectCase(${i})">
                        <td>${this.esc(c.name)}</td>
                        <td class="itn-cell">${this.esc(c.itn)}</td>
                        <td class="notes-cell">${this.esc(truncNotes)}</td>
                    </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            },

            // â”€â”€â”€ Select a case â”€â”€â”€
            selectCase(index) {
                this.selectedCase = this.cases[index];
                if (!this.selectedCase) return;

                // Hide list, show detail
                document.getElementById('caseListSection').classList.add('hidden');
                document.getElementById('caseDetailSection').classList.remove('hidden');

                const card = document.getElementById('caseDetailCard');
                const c = this.selectedCase;

                card.innerHTML = `
                    <div class="detail-row">
                        <div class="detail-field">
                            <div class="detail-label">Analyst</div>
                            <div class="detail-value">${this.esc(c.name)}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">ITN</div>
                            <div class="detail-value mono">${this.esc(c.itn)}</div>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-field">
                            <div class="detail-label">Date</div>
                            <div class="detail-value mono">${this.esc(c.date)}</div>
                        </div>
                        <div class="detail-field">
                            <div class="detail-label">Resolution</div>
                            <div class="detail-value">${this.esc(c.reso)}</div>
                        </div>
                    </div>
                    <div class="detail-notes-block">
                        <div class="detail-label">QA Notes</div>
                        <div class="detail-notes-text">${this.esc(c.notes)}</div>
                    </div>
                `;

                // Pre-fill existing SME notes
                document.getElementById('smeNotesInput').value = c.smeNotes || '';
            },

            // â”€â”€â”€ Back to list â”€â”€â”€
            backToList() {
                document.getElementById('caseDetailSection').classList.add('hidden');
                document.getElementById('caseListSection').classList.remove('hidden');
                this.selectedCase = null;
            },

            // â”€â”€â”€ Save SME notes â”€â”€â”€
            saveNotes() {
                if (!this.selectedCase) return;

                const notes = document.getElementById('smeNotesInput').value.trim();
                const btn = document.getElementById('smeSaveBtn');

                btn.textContent = 'Saving...';
                btn.classList.add('saving');
                btn.disabled = true;

                google.script.run
                    .withSuccessHandler(result => {
                        btn.textContent = 'Save Notes';
                        btn.classList.remove('saving');
                        btn.disabled = false;

                        if (result && result.success) {
                            // Update local state
                            this.selectedCase.smeNotes = notes;
                            const idx = this.cases.findIndex(c => c.rowIndex === this.selectedCase.rowIndex);
                            if (idx !== -1) this.cases[idx].smeNotes = notes;
                            this.showToast('Notes saved', false);
                        } else {
                            this.showToast(result?.message || 'Failed to save', true);
                        }
                    })
                    .withFailureHandler(err => {
                        btn.textContent = 'Save Notes';
                        btn.classList.remove('saving');
                        btn.disabled = false;
                        this.showToast('Error saving notes', true);
                        console.error(err);
                    })
                    .faSaveSmeNotes(this.selectedCase.rowIndex, notes);
            },

            // â”€â”€â”€ Toast â”€â”€â”€
            showToast(msg, isError) {
                const toast = document.getElementById('faToast');
                toast.textContent = msg;
                toast.className = 'fa-toast show' + (isError ? ' error' : '');
                setTimeout(() => toast.classList.remove('show'), 3000);
            },

            // â”€â”€â”€ Escape HTML â”€â”€â”€
            esc(str) {
                if (!str) return '';
                const el = document.createElement('span');
                el.textContent = str;
                return el.innerHTML;
            }
        };

        // Auto-init
        document.addEventListener('DOMContentLoaded', () => FACoaching.init());
    </script>
</body>

</html>
