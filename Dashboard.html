<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ØN - Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- Global Theme -->
    <?!= include('Theme'); ?>
    <?!= include('ThemeState'); ?>

    <style>
        /* Dashboard-specific styles */
        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            font-size: 24px;
            font-weight: 300;
            color: var(--accent-primary);
            letter-spacing: -2px;
            text-decoration: none;
        }

        .nav {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 16px;
            font-size: 13px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 6px;
            transition: all 150ms;
        }

        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .nav-link.active {
            color: var(--text-primary);
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-badge {
            font-size: 11px;
            color: var(--text-muted);
        }

        .admin-badge {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--state-accepted);
            color: #000;
            border-radius: 3px;
            font-weight: 600;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 150ms;
            background: transparent;
            border: none;
            font-size: 16px;
        }

        .icon-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .main {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 500;
        }

        .filters-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .filter-select {
            padding: 8px 12px;
            font-size: 12px;
            font-family: var(--font-ui);
            color: var(--text-primary);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 140px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-family: var(--font-ui);
            font-size: 12px;
            font-weight: 500;
            border-radius: 6px;
            border: 1px solid var(--border);
            cursor: pointer;
            background: transparent;
            color: var(--text-primary);
            transition: all 150ms;
        }

        .btn:hover {
            border-color: var(--border-hover);
            background: var(--bg-elevated);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-box {
            padding: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 150ms;
        }

        .stat-box:hover {
            border-color: var(--border-hover);
        }

        .stat-box.active {
            border-color: var(--accent-primary);
        }

        .stat-number {
            font-size: 40px;
            font-weight: 600;
            font-family: var(--font-data);
        }

        .stat-number.all {
            color: var(--text-primary);
        }

        .stat-number.pending {
            color: var(--state-pending);
        }

        .stat-number.accepted {
            color: var(--state-accepted);
        }

        .stat-number.rejected {
            color: var(--state-rejected);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .chart-container {
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 32px;
            color: var(--text-muted);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="header">
            <div class="header-left">
                <a href="<?= ScriptApp.getService().getUrl() ?>" class="logo">Ø</a>
                <nav class="nav">
                    <a class="nav-link" href="<?= ScriptApp.getService().getUrl() ?>?page=queue">Reports Queue</a>
                    <a class="nav-link" href="<?= ScriptApp.getService().getUrl() ?>?page=admin">Admin Panel</a>
                    <a class="nav-link active"
                        href="<?= ScriptApp.getService().getUrl() ?>?page=dashboard">Dashboard</a>
                </nav>
            </div>
            <div class="header-right">
                <span class="user-badge">
                    <?= user ?>
                </span>
                <span class="admin-badge">Admin</span>
                <button class="theme-toggle" onclick="Theme.toggle()" title="Toggle theme"
                    aria-label="Toggle dark/light mode">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5" />
                        <path
                            d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="main">
            <div class="page-header">
                <h1 class="page-title">Analytics Dashboard</h1>
                <div class="filters-bar">
                    <div class="filter-group">
                        <span class="filter-label">Team</span>
                        <select class="filter-select" id="filter-team" onchange="applyFilters()">
                            <option value="">All Teams</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Classification</span>
                        <select class="filter-select" id="filter-class" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="Master">Master</option>
                            <option value="Derived">Derived</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Period</span>
                        <select class="filter-select" id="filter-period" onchange="applyFilters()">
                            <option value="">All Time</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 90 Days</option>
                        </select>
                    </div>
                    <button class="btn" onclick="resetFilters()">↻ Reset</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box" onclick="filterByState('')">
                    <div class="stat-number all" id="stat-total">-</div>
                    <div class="stat-label">Total Reports</div>
                </div>
                <div class="stat-box" onclick="filterByState('Pending')">
                    <div class="stat-number pending" id="stat-pending">-</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-box" onclick="filterByState('Accepted')">
                    <div class="stat-number accepted" id="stat-accepted">-</div>
                    <div class="stat-label">Accepted</div>
                </div>
                <div class="stat-box" onclick="filterByState('Rejected')">
                    <div class="stat-number rejected" id="stat-rejected">-</div>
                    <div class="stat-label">Rejected</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Reports by State</div>
                    </div>
                    <div class="chart-container" id="chart-state">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Reports by Team</div>
                    </div>
                    <div class="chart-container" id="chart-team">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Classification Distribution</div>
                    </div>
                    <div class="chart-container" id="chart-class">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Reports by Frequency</div>
                    </div>
                    <div class="chart-container" id="chart-freq">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        var App = {
            rawData: null,
            filteredData: null,
            colors: ['#6366f1', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#22c55e', '#f59e0b']
        };

        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(initDashboard);

        function toggleTheme() {
            Theme.toggle();
            if (App.filteredData) drawCharts(App.filteredData);
        }

        function initDashboard() {
            loadDashboardData();
        }

        function loadDashboardData() {
            google.script.run.withSuccessHandler(function (data) {
                App.rawData = data;
                populateTeamFilter(data);
                App.filteredData = data;
                renderStats(data);
                drawCharts(data);
            }).withFailureHandler(function (e) {
                console.error('Failed to load dashboard:', e);
            }).getDashboardStats();
        }

        function populateTeamFilter(data) {
            var select = document.getElementById('filter-team');
            if (data.byTeam) {
                Object.keys(data.byTeam).forEach(function (team) {
                    var opt = document.createElement('option');
                    opt.value = team;
                    opt.textContent = team;
                    select.appendChild(opt);
                });
            }
        }

        function applyFilters() {
            // For now, just refresh - in production this would filter client-side or make new API call
            loadDashboardData();
        }

        function resetFilters() {
            document.getElementById('filter-team').value = '';
            document.getElementById('filter-class').value = '';
            document.getElementById('filter-period').value = '';
            loadDashboardData();
        }

        function filterByState(state) {
            window.location.href = '<?= ScriptApp.getService().getUrl() ?>?page=queue' + (state ? '&state=' + state : '');
        }

        function renderStats(data) {
            document.getElementById('stat-total').textContent = data.totalReports || 0;
            document.getElementById('stat-pending').textContent = data.byState ? data.byState.pending : 0;
            document.getElementById('stat-accepted').textContent = data.byState ? data.byState.accepted : 0;
            document.getElementById('stat-rejected').textContent = data.byState ? data.byState.rejected : 0;
        }

        function drawCharts(data) {
            if (!data) return;
            var isDark = (document.body.getAttribute('data-theme') || 'dark') === 'dark';
            var baseOptions = {
                backgroundColor: 'transparent',
                legend: {
                    position: 'bottom',
                    textStyle: { color: isDark ? '#808080' : '#666666', fontSize: 11 }
                },
                pieSliceTextStyle: { color: '#ffffff', fontSize: 12 },
                chartArea: { width: '90%', height: '75%' },
                titleTextStyle: { color: isDark ? '#f5f5f5' : '#1a1a1a' }
            };

            // State pie chart - with status colors
            if (data.byState) {
                var stateData = google.visualization.arrayToDataTable([
                    ['State', 'Count'],
                    ['Pending', data.byState.pending || 0],
                    ['Accepted', data.byState.accepted || 0],
                    ['Rejected', data.byState.rejected || 0]
                ]);
                var stateChart = new google.visualization.PieChart(document.getElementById('chart-state'));
                stateChart.draw(stateData, Object.assign({}, baseOptions, {
                    colors: ['#f59e0b', '#22c55e', '#ef4444'],
                    pieHole: 0.4
                }));
            }

            // Team pie chart - with vibrant colors
            if (data.byTeam) {
                var teamRows = [['Team', 'Reports']];
                var teamKeys = Object.keys(data.byTeam).sort(function (a, b) { return data.byTeam[b] - data.byTeam[a]; });
                teamKeys.forEach(function (team) {
                    teamRows.push([team, data.byTeam[team]]);
                });
                var teamData = google.visualization.arrayToDataTable(teamRows);
                var teamChart = new google.visualization.PieChart(document.getElementById('chart-team'));
                teamChart.draw(teamData, Object.assign({}, baseOptions, {
                    colors: App.colors,
                    pieHole: 0.4
                }));
            }

            // Classification pie chart - with vibrant colors
            if (data.byClassification) {
                var classData = google.visualization.arrayToDataTable([
                    ['Classification', 'Count'],
                    ['Master', data.byClassification.Master || 0],
                    ['Derived', data.byClassification.Derived || 0]
                ]);
                var classChart = new google.visualization.PieChart(document.getElementById('chart-class'));
                classChart.draw(classData, Object.assign({}, baseOptions, {
                    colors: ['#6366f1', '#ec4899'],
                    pieHole: 0.4
                }));
            }

            // Frequency chart - with vibrant colors
            if (data.byFrequency) {
                var freqRows = [['Frequency', 'Reports']];
                Object.keys(data.byFrequency).forEach(function (freq) {
                    freqRows.push([freq, data.byFrequency[freq]]);
                });
                var freqData = google.visualization.arrayToDataTable(freqRows);
                var freqChart = new google.visualization.PieChart(document.getElementById('chart-freq'));
                freqChart.draw(freqData, Object.assign({}, baseOptions, {
                    colors: ['#14b8a6', '#8b5cf6', '#f97316', '#06b6d4'],
                    pieHole: 0.4
                }));
            } else {
                document.getElementById('chart-freq').innerHTML = '<div style="color:var(--text-muted);font-size:12px;">No frequency data</div>';
            }
        }
    </script>
</body>

</html>