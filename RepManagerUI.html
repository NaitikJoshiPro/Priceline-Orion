<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Representation Engine</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap"
    rel="stylesheet">

  <!-- Global Theme -->
  <?!= include('Theme'); ?>
  <?!= include('ThemeState'); ?>

  <style>
    /* RepManagerUI-specific styles */
    .main-container {
      display: flex;
      height: calc(100vh - 65px);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .rep-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-secondary);
    }

    .rep-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .rep-logo {
      font-size: 32px;
      font-weight: 300;
      color: var(--text-primary);
      text-decoration: none;
    }

    .rep-logo:hover {
      color: var(--state-success);
    }

    .rep-page-title {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .rep-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .rep-back-btn {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s;
    }

    .rep-back-btn:hover {
      border-color: var(--border-hover);
      color: var(--text-primary);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .main-container {
      display: flex;
      height: calc(100vh - 65px);
    }

    .sidebar {
      width: 220px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 24px 16px;
    }

    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           SIDEBAR ACTIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .action-section h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .action-btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: var(--font-ui);
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }

    .action-btn:hover {
      border-color: var(--border-hover);
      transform: translateX(4px);
    }

    .action-btn.challenge {
      border-left: 3px solid var(--accent);
    }

    .action-btn.accept {
      border-left: 3px solid #3b82f6;
    }

    .action-btn.reversal {
      border-left: 3px solid var(--warning);
    }

    .action-btn.autoclosed {
      border-left: 3px solid var(--text-muted);
    }

    .action-btn.recreate {
      border-left: 3px solid var(--danger);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARDS ROW
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .cards-row {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      flex: 1;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      text-align: center;
    }

    .stat-card.visa {
      border-top: 3px solid var(--visa);
    }

    .stat-card.mastercard {
      border-top: 3px solid var(--mastercard);
    }

    .stat-card.discover {
      border-top: 3px solid var(--discover);
    }

    .stat-card.amex {
      border-top: 3px solid #0073CF;
    }

    .stat-card.affirm {
      border-top: 3px solid #0FA0EA;
    }

    .stat-card.braintree {
      border-top: 3px solid #7433FF;
    }

    .stat-card.chase {
      border-top: 3px solid #117ACA;
    }

    .stat-card.fiserv {
      border-top: 3px solid #FF6600;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CONTROLS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .controls-row {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      align-items: center;
    }

    .select-input {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: var(--font-ui);
      min-width: 160px;
    }

    .select-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .primary-btn {
      padding: 10px 24px;
      background: var(--accent-primary);
      border: none;
      border-radius: 6px;
      color: var(--bg-primary);
      font-size: 14px;
      font-weight: 500;
      font-family: var(--font-ui);
      cursor: pointer;
      transition: all 0.2s;
    }

    .primary-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
      background: var(--state-success);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CASE INFO
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .case-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .case-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .field-value {
      font-size: 15px;
      color: var(--text-primary);
      padding: 8px 12px;
      background: var(--bg-elevated);
      border-radius: 6px;
      min-height: 36px;
      font-family: var(--font-mono);
    }

    .field-value.large {
      min-height: 80px;
      font-family: var(--font-ui);
      white-space: pre-wrap;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FILES TABLE
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .files-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .files-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .files-header h3 {
      font-size: 16px;
      font-weight: 500;
    }

    .files-actions {
      display: flex;
      gap: 8px;
    }

    .secondary-btn {
      padding: 8px 16px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: var(--font-ui);
      cursor: pointer;
      transition: all 0.2s;
    }

    .secondary-btn:hover {
      border-color: var(--border-hover);
    }

    .files-table {
      width: 100%;
      border-collapse: collapse;
    }

    .files-table th {
      text-align: left;
      padding: 12px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .files-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .files-table tr:hover td {
      background: var(--bg-elevated);
    }

    .files-table a {
      color: var(--accent);
      text-decoration: none;
    }

    .files-table a:hover {
      text-decoration: underline;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
    }

    #row {
      display: none;
    }
  </style>
</head>

<body>
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         HEADER
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="rep-header">
    <div class="rep-header-left">
      <a href="<?= ScriptApp.getService().getUrl() ?>" class="rep-logo">Ã˜</a>
      <span class="rep-page-title">Representation Engine</span>
    </div>
    <div class="rep-header-right">
      <button class="theme-toggle" onclick="Theme.toggle()" title="Toggle theme" aria-label="Toggle dark/light mode">
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5" />
          <path
            d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" />
        </svg>
        <svg class="icon-moon" viewBox="0 0 24 24" fill="currentColor">
          <path
            d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
        </svg>
      </button>
      <a href="<?= ScriptApp.getService().getUrl() ?>?page=cb" class="rep-back-btn">â† Back to Chargeback</a>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MAIN LAYOUT
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main-container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="action-section">
        <h3>Case Actions</h3>
        <button class="action-btn challenge" onclick="Challenge()">âœ“ Challenge</button>
        <button class="action-btn accept" onclick="Accept()">âœ“ Accept</button>
        <button class="action-btn reversal" onclick="Reversal()">â†© Reversal</button>
        <button class="action-btn autoclosed" onclick="AutoClosed()">âœ• Auto-closed</button>
        <button class="action-btn recreate" onclick="RecreateRequest()">âŸ³ Recreate Request</button>
      </div>
    </aside>

    <!-- CONTENT -->
    <main class="content">
      <!-- Stats Cards -->
      <div class="cards-row">
        <div class="stat-card amex">
          <div class="stat-label">Amex</div>
          <div class="stat-value" id="count-amex">-</div>
        </div>
        <div class="stat-card affirm">
          <div class="stat-label">Affirm</div>
          <div class="stat-value" id="count-affirm">-</div>
        </div>
        <div class="stat-card braintree">
          <div class="stat-label">Braintree</div>
          <div class="stat-value" id="count-braintree">-</div>
        </div>
        <div class="stat-card chase">
          <div class="stat-label">Chase</div>
          <div class="stat-value" id="count-chase">-</div>
        </div>
        <div class="stat-card fiserv">
          <div class="stat-label">Fiserv</div>
          <div class="stat-value" id="count-fiserv">-</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls-row">
        <select class="select-input" id="portal">
          <option value="">Select Portal</option>
          <option value="Amex">Amex</option>
          <option value="Affirm">Affirm</option>
          <option value="Braintree">Braintree</option>
          <option value="Chase">Chase</option>
          <option value="Fiserv">Fiserv</option>
        </select>
        <select class="select-input" id="currency">
          <option value="">Select Currency</option>
          <option value="USD">USD / CAD</option>
          <option value="NON-USD">Non-USD / Non-CAD</option>
        </select>
        <button class="primary-btn" onclick="getCase()">Get Next Case</button>
      </div>

      <!-- Case Info -->
      <div class="case-card">
        <label id="row"></label>
        <div class="case-grid">
          <div class="field-group">
            <span class="field-label">Case ID</span>
            <div class="field-value" id="caseId"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Merchant Order / ITN</span>
            <div class="field-value" id="ITN"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Reason Code</span>
            <div class="field-value" id="ReasonCode"></div>
          </div>
          <div class="field-group">
            <span class="field-label">MOP</span>
            <div class="field-value" id="mop"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Reservation #</span>
            <div class="field-value" id="reservation"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Due Date</span>
            <div class="field-value" id="dueDate"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Dispute Amount</span>
            <div class="field-value" id="disputeAmt"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Transaction Amount</span>
            <div class="field-value" id="transAmt"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Refund Amount</span>
            <div class="field-value" id="refundAmt"></div>
          </div>
          <div class="field-group">
            <span class="field-label">Dispute Type</span>
            <div class="field-value" id="disputeType"></div>
          </div>
        </div>
        <div style="margin-top: 16px;">
          <div class="field-group">
            <span class="field-label">RCA Decision</span>
            <div class="field-value" id="rca"></div>
          </div>
        </div>
        <div style="margin-top: 16px;">
          <div class="field-group">
            <span class="field-label">Internal Notes</span>
            <div class="field-value large" id="internalNotes"></div>
          </div>
        </div>
      </div>

      <!-- Files Section -->
      <div class="files-section">
        <div class="files-header">
          <div class="files-actions">
            <button class="secondary-btn" onclick="findFiles()">ğŸ” Find Files</button>
            <button class="secondary-btn" onclick="DownloadFiles()">â¬‡ Download Selected</button>
          </div>
          <h3>Related Files</h3>
        </div>
        <table class="files-table" id="filesfound">
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="check-all" onchange="toggle()"></th>
              <th>File Name</th>
              <th style="width: 160px;">Last Modified</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    // Initialize counts on load
    document.addEventListener('DOMContentLoaded', function () {
      getCount();
    });

    function getCase() {
      getCount();
      clearFiles();
      var portal = document.getElementById("portal").value;
      var currency = document.getElementById("currency").value;
      if (portal === "" || currency === "") {
        clearData();
        return;
      }
      document.getElementById("caseId").textContent = "Fetching...";
      console.log("Fetching case for portal:", portal, "currency:", currency);
      google.script.run
        .withSuccessHandler(function (data) {
          console.log("Case data received:", data);
          updateData(data);
        })
        .withFailureHandler(function (error) {
          console.error("Error fetching case:", error);
          alert("Error fetching case: " + error.message);
          document.getElementById("caseId").textContent = "Error - check console";
        })
        .rmGetPendingUploads(portal, currency);
    }

    function updateData(data) {
      document.getElementById("row").innerHTML = data[0];
      document.getElementById("caseId").textContent = data[1] || '-';
      document.getElementById("ITN").textContent = data[2] || '-';
      document.getElementById("ReasonCode").textContent = data[3] || '-';
      document.getElementById("mop").textContent = data[4] || '-';
      document.getElementById("reservation").textContent = data[5] || '-';
      document.getElementById("disputeAmt").textContent = data[6] || '-';
      document.getElementById("transAmt").textContent = data[7] || '-';
      document.getElementById("refundAmt").textContent = data[8] || '-';
      document.getElementById("dueDate").textContent = data[9] || '-';
      document.getElementById("disputeType").textContent = data[10] || '-';
      document.getElementById("rca").textContent = data[11] || '-';
      document.getElementById("internalNotes").textContent = data[12] || '-';
    }

    function clearData() {
      ['caseId', 'ITN', 'ReasonCode', 'mop', 'reservation', 'disputeAmt',
        'transAmt', 'refundAmt', 'dueDate', 'disputeType', 'rca', 'internalNotes']
        .forEach(id => document.getElementById(id).textContent = '-');
      document.getElementById("row").innerHTML = "";
    }

    function Challenge() {
      var row = document.getElementById("row").innerHTML;
      if (!row) return alert("No case selected");

      setLoading(true);
      showToast('Processing Challenge...', 'info');

      google.script.run.withSuccessHandler(function () {
        showToast('Case Challenged Successfully', 'success');
        getCase();
        setLoading(false);
      }).withFailureHandler(function (e) {
        showToast('Error: ' + e.message, 'error');
        setLoading(false);
      }).rmChallenge(parseInt(row));
    }

    function Accept() {
      var row = document.getElementById("row").innerHTML;
      if (!row) return alert("No case selected");

      setLoading(true);
      showToast('Processing Accept...', 'info');

      google.script.run.withSuccessHandler(function () {
        showToast('Case Accepted Successfully', 'success');
        getCase();
        setLoading(false);
      }).withFailureHandler(function (e) {
        showToast('Error: ' + e.message, 'error');
        setLoading(false);
      }).rmAccept(parseInt(row));
    }

    function Reversal() {
      var row = document.getElementById("row").innerHTML;
      if (!row) return alert("No case selected");

      setLoading(true);
      showToast('Processing Reversal...', 'info');

      google.script.run.withSuccessHandler(function () {
        showToast('Case Reversed Successfully', 'success');
        getCase();
        setLoading(false);
      }).withFailureHandler(function (e) {
        showToast('Error: ' + e.message, 'error');
        setLoading(false);
      }).rmReversal(parseInt(row));
    }

    function AutoClosed() {
      var row = document.getElementById("row").innerHTML;
      if (!row) return alert("No case selected");

      setLoading(true);
      showToast('Processing Auto-Close...', 'info');

      google.script.run.withSuccessHandler(function () {
        showToast('Case Auto-Closed Successfully', 'success');
        getCase();
        setLoading(false);
      }).withFailureHandler(function (e) {
        showToast('Error: ' + e.message, 'error');
        setLoading(false);
      }).rmAutoclosed(parseInt(row));
    }

    function RecreateRequest() {
      var row = document.getElementById("row").innerHTML;
      if (!row) return alert("No case selected");
      var res = prompt("Reason for Recreate Request");
      if (res) {
        setLoading(true);
        showToast('Submitting Request...', 'info');

        google.script.run.withSuccessHandler(function () {
          showToast('Recreate Request Sent', 'success');
          getCase();
          setLoading(false);
        }).withFailureHandler(function (e) {
          showToast('Error: ' + e.message, 'error');
          setLoading(false);
        }).rmRecreate(parseInt(row), res);
      }
    }

    function setLoading(isLoading) {
      const btns = document.querySelectorAll('.action-btn');
      btns.forEach(btn => {
        btn.disabled = isLoading;
        btn.style.opacity = isLoading ? '0.5' : '1';
        btn.style.cursor = isLoading ? 'not-allowed' : 'pointer';
      });
    }

    function showToast(message, type = 'info') {
      // Create toast container if not exists
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.position = 'fixed';
        container.style.top = '20px';
        container.style.right = '20px';
        container.style.zIndex = '9999';
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '10px';
        document.body.appendChild(container);
      }

      const toast = document.createElement('div');
      toast.textContent = message;
      toast.style.padding = '12px 24px';
      toast.style.borderRadius = '6px';
      toast.style.color = '#fff';
      toast.style.fontFamily = 'var(--font-ui)';
      toast.style.fontSize = '14px';
      toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      toast.style.transition = 'all 0.3s ease';
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';

      // Set color based on type
      if (type === 'success') toast.style.backgroundColor = 'var(--state-success, #10b981)';
      else if (type === 'error') toast.style.backgroundColor = 'var(--danger, #ef4444)';
      else toast.style.backgroundColor = 'var(--accent, #3b82f6)';

      container.appendChild(toast);

      // Animate in
      requestAnimationFrame(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      });

      // Remove after 3s
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function getCount() {
      console.log("Fetching counts...");
      google.script.run
        .withSuccessHandler(function (counts) {
          console.log("Counts received:", counts);
          UpdateCounts(counts);
        })
        .withFailureHandler(function (error) {
          console.error("Error fetching counts:", error);
          alert("Error fetching counts: " + error.message);
        })
        .rmGetCounts();
    }

    function UpdateCounts(counts) {
      document.getElementById("count-amex").textContent = counts[0] || 0;
      document.getElementById("count-affirm").textContent = counts[1] || 0;
      document.getElementById("count-braintree").textContent = counts[2] || 0;
      document.getElementById("count-chase").textContent = counts[3] || 0;
      document.getElementById("count-fiserv").textContent = counts[4] || 0;
    }

    function findFiles() {
      var itn = document.getElementById("ITN").textContent;
      if (!itn || itn === '-') return alert("No ITN to search");

      // Show loading state
      var tbody = document.querySelector('#filesfound tbody');
      tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;">Searching...</td></tr>';

      google.script.run
        .withSuccessHandler(function (files) {
          clearFiles();
          if (!files || files.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:var(--text-muted);">No files found for this ITN</td></tr>';
            return;
          }

          files.forEach(function (file) {
            var row = document.createElement('tr');
            row.innerHTML =
              '<td><input type="checkbox" data-fileid="' + file[1] + '"></td>' +
              '<td><a href="https://drive.google.com/file/d/' + file[1] + '/view" target="_blank">' + file[0] + '</a></td>' +
              '<td>' + file[2] + '</td>';
            tbody.appendChild(row);
          });
        })
        .withFailureHandler(function (error) {
          console.error("Error searching files:", error);
          tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:var(--danger);">Error: ' + error.message + '</td></tr>';
        })
        .rmSearchFiles(itn);
    }

    function clearFiles() {
      var tbody = document.querySelector('#filesfound tbody');
      tbody.innerHTML = '';
    }

    function toggle() {
      var checkAll = document.getElementById("check-all");
      var checkboxes = document.querySelectorAll('#filesfound tbody input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = checkAll.checked);
    }

    function DownloadFiles() {
      var checkboxes = document.querySelectorAll('#filesfound tbody input[type="checkbox"]:checked');
      if (checkboxes.length === 0) {
        alert("No files selected");
        return;
      }

      // Download each selected file
      checkboxes.forEach(function (cb, index) {
        var fileId = cb.getAttribute('data-fileid');
        if (fileId) {
          // Use export URL to trigger download instead of view
          var downloadUrl = 'https://drive.google.com/uc?export=download&id=' + fileId;
          // Stagger the downloads slightly to prevent popup blockers
          setTimeout(function () {
            window.open(downloadUrl, '_blank');
          }, index * 300);
        }
      });
    }
  </script>
</body>

</html>